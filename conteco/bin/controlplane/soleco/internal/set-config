#!/usr/bin/env bash
imageName="$1"
component="$2"
if [[ "$component" == "." ]] ; then component=""; fi
DOLLAR='$'

# solutions have solution level configuration
# use solution namespace suffix as prefix for local network and module prefix
if [[ "${CONTECO_ECOSYSTEM_RUNTIME}" != "${CONTECO_NAME_CONTROLPLANE}" ]] ; then
  prefix="${CONTECO_ECOSYSTEM_RUNTIME:${#CONTECO_NAME_CONTROLPLANE}+1}_"
fi
if [[ "$component" != "" ]] ; then
  if [[ "$SOLECO_NETWORKLOCAL_PARENT" == "true" ]] ; then
    suffix="$(dirname "/$component" | tr '/' '_')"
    if [[ "$suffix" == "_" ]] ; then suffix=""; fi
  else
    suffix="$(echo "/$component" | tr '/' '_')"
  fi
  urlSuffix="/$component";
fi
export MODECO_HOSTNAME="${SOLECO_HOSTNAME}"
export CONTECO_NETWORKGLOBAL="${CONTECO_NAME_CONTROLPLANE}"
export CONTECO_NETWORKLOCAL="${prefix}${CONTECO_TYPE}_${CONTECO_NAME}${suffix}"
export MODECO_MODULEPREFIX="${prefix}${CONTECO_TYPE}_${CONTECO_NAME}${suffix}"
export MODECO_URLPREFIX="${CONTECO_TYPE}_${CONTECO_NAME}${urlSuffix}"
export MODECO_STACKSCOPE="${prefix}${CONTECO_TYPE}_${CONTECO_NAME}${urlSuffix}"

# solution level config overrides component
folder="soleco"
. invoke-script $imageName ${folder}/configuration
if [[ "$component" != "" ]] ; then folder="soleco/$component"; fi
. invoke-script $imageName ${folder}/_component/_configuration
